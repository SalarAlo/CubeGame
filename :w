#include <nlohmann/json.hpp>

#include <fstream>
#include <sstream>

#include "LevelManager.h"
#include "LevelConfig.h"
#include "LuaExecutor.h"
#include "Scene.h"
#include "Cube.h"
#include "Utils.h"
#include "nlohmann/json_fwd.hpp"

Scene LevelManager::LoadLevel(int idx) {
        LevelFiles files { GetLevelFiles(idx) };
        Scene scene {};

        files.ConfigData.at("name").get_to(scene.Config.Name);
        files.ConfigData.at("light_color").get_to(scene.Config.LightColor);
        files.ConfigData.at("sizes").get_to(scene.Config.Sizes);


        std::vector<Cube> data {};
        
        forEachVoxel(
                scene.Config.Sizes[0], 
                scene.Config.Sizes[1], 
                scene.Config.Sizes[2], 

                [&](int x, int y, int z) {
                        LuaExecutor executor {};
                        executor.SetSourceCode(files.LuaSourceCode);
                        glm::vec3 position { x, y, z };
                        auto color = executor.GetColor(position);

                        if(color == -1) return;

                        auto colorType = static_cast<MeshColor::Type>(color);
                        MeshColor colorObj { colorType };
                        Cube cube { position, colorObj };
                        data.push_back(cube);
                }
        );


        return scene;
}

LevelManager::LevelFiles LevelManager::GetLevelFiles(int idx) const {
        LevelFiles files {};
        
        SetLevelConfigData(files, idx);
        SetLevelLuaSource(file, idx);
        

        return files;
}

void LevelManager::SetLevelLuaSource(LevelFiles& levelFiles, int idx) const {
        const std::string luaPath { levelDirectory + "/scene.lua" };
        std::ifstream luaFile { configPath };
        if(!luaFile) {
                assert(false && "Trying to access level lua file data which is non existent");
        }

        std::stringstream buffer {};
        buffer << luaFile.rdbuf();
        files.LuaSourceCode = buffer.str();
}

void LevelManager::SetLevelConfigData(LevelFiles& levelFiles, int idx) const {
        const std::string levelDirectory { "../resources/levels/level/level_" + idx };
        const std::string configPath { levelDirectory + "/config.json" };
        std::ifstream configFile(configPath);
        if(!configFile) {
                assert(false && "Trying to access level json config data which is non existent");
        }
        configFile >> levelFiles.ConfigData;
}

bool LevelManager::CheckPlayerSolution(const std::vector<Cube>& playerVoxels) {
        return false;
}
